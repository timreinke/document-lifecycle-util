(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{234:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return WriteDebouncer})),__webpack_require__.d(__webpack_exports__,"b",(function(){return mkWriteDebouncer}));var xstate__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(174),xstate__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(8),xstate__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(65),wasFlushDirtied=function wasFlushDirtied(_ctx,_e,meta){return"DIRTY"==meta.state.value.FLUSHING},WriteDebouncer=function WriteDebouncer(){return Object(xstate__WEBPACK_IMPORTED_MODULE_0__.b)({id:"debouncer",initial:"IDLE",states:{IDLE:{on:{WRITE:{actions:"handleWrite",target:"DEBOUNCE",cond:"shouldWrite"}}},DEBOUNCE:{on:{WRITE:{target:"DEBOUNCE",actions:"handleWrite",cond:"shouldWrite"}},after:{DEBOUNCE_TIME:{target:"FLUSHING"}}},FLUSHING:{invoke:{src:"flush",onDone:[{cond:wasFlushDirtied,target:"DEBOUNCE",actions:[Object(xstate__WEBPACK_IMPORTED_MODULE_1__.b)({error:function error(_ctx,_e){}}),"onWrite"]},{actions:["onWrite",Object(xstate__WEBPACK_IMPORTED_MODULE_1__.b)({error:function error(_ctx,_e){}})],target:"IDLE"}],onError:{actions:xstate__WEBPACK_IMPORTED_MODULE_2__.actions.pure((function(_context,event){return[xstate__WEBPACK_IMPORTED_MODULE_2__.actions.raise({type:"ERROR",message:event.data})]}))}},initial:"CLEAN",states:{CLEAN:{},DIRTY:{}},on:{WRITE:{target:".DIRTY",actions:"handleWrite",cond:"shouldWrite"},ERROR:{target:"DEBOUNCE",actions:Object(xstate__WEBPACK_IMPORTED_MODULE_1__.b)({error:function error(_ctx,e){return e.message}})},SUCCESS:[{cond:wasFlushDirtied,target:"DEBOUNCE"},{actions:Object(xstate__WEBPACK_IMPORTED_MODULE_1__.b)({error:function error(_ctx,_e){}}),target:"IDLE"}]}}}},{actions:{handleWrite:Object(xstate__WEBPACK_IMPORTED_MODULE_1__.b)({latestContents:function latestContents(_ctx,e){return e.value}})},guards:{shouldWrite:function shouldWrite(){return!0}}})};function mkWriteDebouncer(initialContents){return WriteDebouncer().withContext({latestContents:initialContents,error:void 0})}},313:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Basic",(function(){return Basic}));__webpack_require__(63),__webpack_require__(23),__webpack_require__(870),__webpack_require__(12);var xstate__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(129),_xstate_react__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(237),_util__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(91),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__=(__webpack_require__(0),__webpack_require__(11));__webpack_exports__.default={title:"Debouncer"};var Basic=function Basic(){var dbService=Object(xstate__WEBPACK_IMPORTED_MODULE_4__.c)(_util__WEBPACK_IMPORTED_MODULE_6__.d),machine=_util__WEBPACK_IMPORTED_MODULE_6__.e.withConfig({delays:{DEBOUNCE_TIME:1500},services:{flush:function flush(context){return new Promise((function(resolve,reject){return setTimeout((function(){console.log("sending"),Math.random()<.6?reject("oh no there was a ".concat(Math.random()<.5?"client disconnect":"server"," error")):(dbService.send({type:"WRITE",key:"foo",value:context.latestContents}),resolve(null))}),500*Math.random()+500)}))}}}).withContext({latestContents:"",error:void 0}),debouncerService=Object(xstate__WEBPACK_IMPORTED_MODULE_4__.c)(machine);debouncerService.start(),dbService.start();var initialContents="this text field is debounced so you can edit it without getting spammed by database writes";return debouncerService.send({type:"WRITE",value:initialContents}),Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsxs)("div",{style:{},children:["This editor writes to the database after debouncing for 1.5 seconds. The database write call is asynchronous with a latency uniform latency distribution over 0.5-1.0 seconds. The write handler injects failures 60% of the time for this demo.",Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsxs)("div",{children:[Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)("h4",{children:"Editor"}),Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_util__WEBPACK_IMPORTED_MODULE_6__.b,{initialContents:initialContents,onChange:function onChange(contents){debouncerService.send({type:"WRITE",value:contents})}})]}),Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_util__WEBPACK_IMPORTED_MODULE_6__.c,{useDebouncer:_xstate_react__WEBPACK_IMPORTED_MODULE_5__.b,debouncer:debouncerService}),Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_8__.jsx)(_util__WEBPACK_IMPORTED_MODULE_6__.a,{db:dbService})]})};Basic.displayName="Basic",Basic.parameters=Object.assign({storySource:{source:'() => {\n  let dbService = interpret(database);\n\n  let machine = stringOutputDebouncer\n    .withConfig({\n      delays: {\n        DEBOUNCE_TIME: 1500,\n      },\n      services: {\n        flush: (context) => {\n          return new Promise((resolve, reject) =>\n            setTimeout(() => {\n              console.log("sending");\n              if (Math.random() < 0.6) {\n                reject(`oh no there was a ${Math.random() < 0.5 ? \'client disconnect\' : \'server\'} error`)\n                return\n              }\n              dbService.send({\n                type: "WRITE",\n                key: "foo",\n                value: context.latestContents,\n              });\n              resolve(null);\n            }, Math.random() * 500 + 500)\n          );\n        },\n      },\n    })\n    .withContext({\n      latestContents: "",\n      error: undefined,\n    });\n  let debouncerService = interpret(machine);\n  debouncerService.start();\n\n  dbService.start();\n  let initialContents =\n    "this text field is debounced so you can edit it without getting spammed by database writes";\n  debouncerService.send({ type: "WRITE", value: initialContents });\n\n  return (\n    <div style={{}}>\n      This editor writes to the database after debouncing for 1.5 seconds. The database write call is asynchronous\n      with a latency uniform latency distribution over 0.5-1.0 seconds. The write handler injects\n      failures 60% of the time for this demo.\n      <div>\n        <h4>Editor</h4>\n        <DemoEditor\n          initialContents={initialContents}\n          onChange={(contents) => {\n            debouncerService.send({ type: "WRITE", value: contents });\n          }}\n        />\n      </div>\n\n      <DemoIndicator useDebouncer={useService} debouncer={debouncerService} />\n      <DemoDbInspector db={dbService} />\n    </div>\n  );\n}'}},Basic.parameters)},503:function(module,exports,__webpack_require__){__webpack_require__(504),__webpack_require__(660),__webpack_require__(661),__webpack_require__(876),__webpack_require__(873),__webpack_require__(878),__webpack_require__(879),__webpack_require__(877),__webpack_require__(874),__webpack_require__(880),__webpack_require__(854),__webpack_require__(881),module.exports=__webpack_require__(865)},571:function(module,exports){},661:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(366)},865:function(module,exports,__webpack_require__){"use strict";(function(module){(0,__webpack_require__(366).configure)([__webpack_require__(866),__webpack_require__(867),__webpack_require__(868),__webpack_require__(872)],module,!1)}).call(this,__webpack_require__(210)(module))},866:function(module,exports){function webpackEmptyContext(req){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}webpackEmptyContext.keys=function(){return[]},webpackEmptyContext.resolve=webpackEmptyContext,module.exports=webpackEmptyContext,webpackEmptyContext.id=866},867:function(module,exports){function webpackEmptyContext(req){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}webpackEmptyContext.keys=function(){return[]},webpackEmptyContext.resolve=webpackEmptyContext,module.exports=webpackEmptyContext,webpackEmptyContext.id=867},868:function(module,exports,__webpack_require__){var map={"./core/stories/docs.stories.mdx":869};function webpackContext(req){var id=webpackContextResolve(req);return __webpack_require__(id)}function webpackContextResolve(req){if(!__webpack_require__.o(map,req)){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}return map[req]}webpackContext.keys=function webpackContextKeys(){return Object.keys(map)},webpackContext.resolve=webpackContextResolve,module.exports=webpackContext,webpackContext.id=868},869:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"__page",(function(){return __page}));__webpack_require__(20),__webpack_require__(31),__webpack_require__(36),__webpack_require__(12),__webpack_require__(0);var _mdx_js_react__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(40),_storybook_addon_docs_blocks__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(181),_debouncer_machine_stories__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(313),_excluded=["components"];function _extends(){return(_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target}).apply(this,arguments)}function _objectWithoutProperties(source,excluded){if(null==source)return{};var key,i,target=function _objectWithoutPropertiesLoose(source,excluded){if(null==source)return{};var key,i,target={},sourceKeys=Object.keys(source);for(i=0;i<sourceKeys.length;i++)key=sourceKeys[i],excluded.indexOf(key)>=0||(target[key]=source[key]);return target}(source,excluded);if(Object.getOwnPropertySymbols){var sourceSymbolKeys=Object.getOwnPropertySymbols(source);for(i=0;i<sourceSymbolKeys.length;i++)key=sourceSymbolKeys[i],excluded.indexOf(key)>=0||Object.prototype.propertyIsEnumerable.call(source,key)&&(target[key]=source[key])}return target}var layoutProps={};function MDXContent(_ref){var components=_ref.components,props=_objectWithoutProperties(_ref,_excluded);return Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("wrapper",_extends({},layoutProps,props,{components:components,mdxType:"MDXLayout"}),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)(_storybook_addon_docs_blocks__WEBPACK_IMPORTED_MODULE_6__.c,{title:"Overview",mdxType:"Meta"}),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("h1",{id:"overview"},"Overview"),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("p",null,"This debouncer is used to debounce document writes. This helps in\nimplementing autosave functionality. Your application can send every\nupdate through to the persistence layer and the persistence layer will\nflush only so often."),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("p",null,"The application may want to indicate to the user when their changes are\nfully flushed or if there is a failure (e.g. a network disconnection).\nIn order for the application to provide this feedback to the user, it\nwill want to observe certain facts about the state of persistence:\nwhether the write buffer is flushed and if there is an error what that\nerror is."),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("p",null,"Additionally, the flush process is asynchronous, so we may receive\nfurther write requests during flushing.  "),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)(_storybook_addon_docs_blocks__WEBPACK_IMPORTED_MODULE_6__.b,{mdxSource:"%0A%3Cdiv%3E%0A%20%20%20%20%3Cspan%20style=%7B%7B%0A%20%20%20%20fontSize:%20%221.2em%22,%0A%20%20%20%20fontWeight:%20%22bold%22%0A%20%20%7D%7D%3EBasic%20Editor%3C/span%3E%0A%20%20%20%20%3Cspan%20style=%7B%7B%0A%20%20%20%20marginLeft:%20%220.4em%22,%0A%20%20%20%20fontSize:%20%220.8em%22%0A%20%20%7D%7D%3E%0A%20%20%20%20%20%20%20%20%3Ca%20href=%22./?path=/story/debouncer--basic%22%3Ezoom%3C/a%3E%0A%20%20%20%20%3C/span%3E%0A%3C/div%3E%0A%0A%3CBasic%20/%3E%0A",mdxType:"Canvas"},Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("div",null,Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("span",{style:{fontSize:"1.2em",fontWeight:"bold"}},"Basic Editor"),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("span",{style:{marginLeft:"0.4em",fontSize:"0.8em"}},Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)("a",{href:"./?path=/story/debouncer--basic"},"zoom"))),Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)(_debouncer_machine_stories__WEBPACK_IMPORTED_MODULE_7__.Basic,{mdxType:"Basic"})))}MDXContent.displayName="MDXContent",MDXContent.isMDXComponent=!0;var __page=function __page(){throw new Error("Docs-only story")};__page.parameters={docsOnly:!0};var componentMeta={title:"Overview",includeStories:["__page"]},mdxStoryNameToKey={};componentMeta.parameters=componentMeta.parameters||{},componentMeta.parameters.docs=Object.assign({},componentMeta.parameters.docs||{},{page:function page(){return Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)(_storybook_addon_docs_blocks__WEBPACK_IMPORTED_MODULE_6__.a,{mdxStoryNameToKey:mdxStoryNameToKey,mdxComponentMeta:componentMeta},Object(_mdx_js_react__WEBPACK_IMPORTED_MODULE_5__.b)(MDXContent,null))}}),__webpack_exports__.default=componentMeta},872:function(module,exports,__webpack_require__){var map={"./core/stories/debouncer.machine.stories.tsx":313,"./core/stories/lifecycle.machine.stories.tsx":882};function webpackContext(req){var id=webpackContextResolve(req);return __webpack_require__(id)}function webpackContextResolve(req){if(!__webpack_require__.o(map,req)){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}return map[req]}webpackContext.keys=function webpackContextKeys(){return Object.keys(map)},webpackContext.resolve=webpackContextResolve,module.exports=webpackContext,webpackContext.id=872},881:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var preview_namespaceObject={};__webpack_require__.r(preview_namespaceObject),__webpack_require__.d(preview_namespaceObject,"parameters",(function(){return parameters}));__webpack_require__(20),__webpack_require__(36),__webpack_require__(56),__webpack_require__(861),__webpack_require__(41),__webpack_require__(42),__webpack_require__(862),__webpack_require__(863),__webpack_require__(864);var client_api=__webpack_require__(87),esm=__webpack_require__(7),parameters={actions:{argTypesRegex:"^on[A-Z].*"},controls:{matchers:{color:/(background|color)$/i,date:/Date$/}},xstate:!0};function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.keys(preview_namespaceObject).forEach((function(key){var value=preview_namespaceObject[key];switch(key){case"args":case"argTypes":return esm.a.warn("Invalid args/argTypes in config, ignoring.",JSON.stringify(value));case"decorators":return value.forEach((function(decorator){return Object(client_api.b)(decorator,!1)}));case"loaders":return value.forEach((function(loader){return Object(client_api.c)(loader,!1)}));case"parameters":return Object(client_api.d)(function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}({},value),!1);case"argTypesEnhancers":return value.forEach((function(enhancer){return Object(client_api.a)(enhancer)}));case"globals":case"globalTypes":var v={};return v[key]=value,Object(client_api.d)(v,!1);default:return console.log(key+" was not supported :( !")}}))},882:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"MultidocumentEditor",(function(){return lifecycle_machine_stories_MultidocumentEditor}));__webpack_require__(63),__webpack_require__(23),__webpack_require__(19),__webpack_require__(106),__webpack_require__(18),__webpack_require__(418),__webpack_require__(306),__webpack_require__(12),__webpack_require__(455),__webpack_require__(36),__webpack_require__(46),__webpack_require__(115),__webpack_require__(48),__webpack_require__(50),__webpack_require__(53),__webpack_require__(68),__webpack_require__(13),__webpack_require__(119);var Machine=__webpack_require__(174),actions=__webpack_require__(8),es=__webpack_require__(65),interpreter=__webpack_require__(129),debouncer_machine=__webpack_require__(234),util=__webpack_require__(91),react=__webpack_require__(0),react_default=__webpack_require__.n(react),useSelector=__webpack_require__(887),useService=__webpack_require__(237),useActor=__webpack_require__(235),jsx_runtime=__webpack_require__(11);function _toConsumableArray(arr){return function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupportedIterableToArray(arr)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=arr&&("undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"]);if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||_unsupportedIterableToArray(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}__webpack_exports__.default={title:"Document Lifecycle"};var lifecycle_machine_stories_MultidocumentEditor=function MultidocumentEditor(){var dbService=Object(interpreter.c)(util.d.withContext({data:{foo:"hello world"}})),testDocMachine=function mkAppLifecycleMachine(load,mkSaveMachine){return Object(Machine.b)({initial:"PRE_LOAD",on:{EXIT:{target:"STOPPED"}},states:{PRE_LOAD:{on:{LOAD:{target:"LOADING"}}},LOADING:{invoke:{id:"loader",src:load,onDone:{target:"RUNNING",actions:Object(actions.b)({contents:function contents(_context,event){return event.data}})},onError:{target:"WAIT_RETRY",actions:Object(actions.b)({error:function error(_,event){return event.data}})}}},WAIT_RETRY:{entry:es.actions.send({type:"RETRY"},{delay:1e3,id:"retry_timer"}),on:{RETRY:"LOADING"}},RUNNING:{entry:Object(actions.b)({persister:function persister(context,_event){return Object(interpreter.d)(mkSaveMachine(context.href,context.contents).withConfig({actions:{onWrite:es.actions.pure((function(c,e){return[Object(actions.r)({type:"WRITE.DONE"})]}))}}),{sync:!0})}}),on:{EXIT:[{target:"CLEANUP",cond:function cond(ctx){var _ctx$persister,_ctx$persister$getSna;return"IDLE"!=(null===(_ctx$persister=ctx.persister)||void 0===_ctx$persister||null===(_ctx$persister$getSna=_ctx$persister.getSnapshot())||void 0===_ctx$persister$getSna?void 0:_ctx$persister$getSna.value)}},{target:"STOPPED"}]}},CLEANUP:{on:{"WRITE.DONE":{target:"STOPPED"}}},STOPPED:{type:"final",entry:Object(actions.b)({persister:function persister(ctx){ctx.persister.stop()}})}}})}(function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(context){return regeneratorRuntime.wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.abrupt("return",dbService.state.context.data[context.href]);case 1:case"end":return _context.stop()}}),_callee)})));return function(_x){return _ref.apply(this,arguments)}}(),(function(href,contents){return Object(debouncer_machine.b)(contents).withConfig({delays:{DEBOUNCE_TIME:1e3},services:{flush:(_flush=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(context){return regeneratorRuntime.wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:dbService.send({type:"WRITE",key:href,value:context.latestContents});case 1:case"end":return _context2.stop()}}),_callee2)}))),function flush(_x2){return _flush.apply(this,arguments)})}});var _flush}));dbService.start();var AppToolbar=function AppToolbar(props){var _React$useState2=_slicedToArray(react_default.a.useState("foo"),2),state=_React$useState2[0],setState=_React$useState2[1];return Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("input",{id:"openHref",type:"text",value:state,onChange:function onChange(e){return setState(e.target.value)}})," ",Object(jsx_runtime.jsx)("button",{onClick:function onClick(){return props.onOpen(state)},children:"Open"})]})},EditorContainer_=function EditorContainer_(props){var initialContents=Object(useSelector.a)(props.service,(function(s){return s.context.contents})),persister=Object(useSelector.a)(props.service,(function(s){return s.context.persister})),href=Object(useSelector.a)(props.service,(function(s){return s.context.href}));return Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("span",{style:{fontSize:"1.2em"},children:href}),Object(jsx_runtime.jsx)("button",{style:{marginLeft:"2em"},onClick:function onClick(){return props.service.send({type:"EXIT"})},children:"X"})]}),Object(jsx_runtime.jsx)(util.b,{initialContents:initialContents,onChange:function onChange(contents){return persister.send({type:"WRITE",value:contents})}})]})},EditorContainer=react_default.a.memo(EditorContainer_),Loading=function Loading(props){var _useService2=_slicedToArray(Object(useService.b)(props.service),2),state=_useService2[0];_useService2[1];return Object(jsx_runtime.jsxs)("div",{children:["Loading ",state.context.href]})},WaitRetry=function WaitRetry(props){var _useService4=_slicedToArray(Object(useService.b)(props.service),2),state=_useService4[0];_useService4[1];return Object(jsx_runtime.jsxs)("div",{children:["Load failed with ",state.context.error,". About to retry..."]})},Running_=function Running_(props){Object(useSelector.a)(props.service,(function(state){return state.context.contents}));var persister=Object(useSelector.a)(props.service,(function(s){return s.context.persister}));return Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)(EditorContainer,{service:props.service}),Object(jsx_runtime.jsx)(util.c,{useDebouncer:useActor.b,debouncer:persister})]})},Running=react_default.a.memo(Running_),Cleanup=function Cleanup(props){var _useService6=_slicedToArray(Object(useService.b)(props.service),2),state=_useService6[0];_useService6[1];return Object(jsx_runtime.jsx)("div",{children:Object(jsx_runtime.jsx)("pre",{children:state.context.persister.getSnapshot().context.latestContents})})},LifecycledEditor=function LifecycledEditor(props){var _useService8=_slicedToArray(Object(useService.b)(props.service),2),state=_useService8[0];_useService8[1];switch(state.value){case"PRE_LOAD":case"LOADING":return Object(jsx_runtime.jsx)(Loading,{service:props.service});case"WAIT_RETRY":return Object(jsx_runtime.jsx)(WaitRetry,{service:props.service});case"RUNNING":return Object(jsx_runtime.jsx)(Running,{service:props.service});case"CLEANUP":return Object(jsx_runtime.jsx)(Cleanup,{service:props.service});case"STOPPED":return Object(jsx_runtime.jsx)("div",{children:"done"})}},EditorGroup=function EditorGroup(props){var editorMachines=react_default.a.useRef({}),editorComponents=props.editors.map((function(key){if(!editorMachines.current[key]){var svc=Object(interpreter.c)(testDocMachine.withContext({href:key}));svc.onDone((function(){delete editorMachines.current[key],props.removeEditor(key)})),svc.start(),editorMachines.current[key]=svc,svc.send({type:"LOAD"})}return Object(jsx_runtime.jsx)(LifecycledEditor,{service:editorMachines.current[key]},key)}));return Object(jsx_runtime.jsx)("div",{children:editorComponents})},Application=function Application(){var _React$useState4=_slicedToArray(react_default.a.useState([]),2),editors=_React$useState4[0],setEditors=_React$useState4[1];return Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)(AppToolbar,{onOpen:function onOpen(key){if(!editors.find((function(v){return v==key}))){var newEditors=[].concat(_toConsumableArray(editors),[key]);setEditors(newEditors)}}}),Object(jsx_runtime.jsx)(EditorGroup,{editors:editors,removeEditor:function removeEditor(key){var i=editors.findIndex((function(v){return v==key})),newEditors=_toConsumableArray(editors);newEditors.splice(i,1),setEditors(newEditors)}})]})};return Object(jsx_runtime.jsxs)("div",{id:"multidocumenteditor",children:[Object(jsx_runtime.jsx)(Application,{}),Object(jsx_runtime.jsx)(util.a,{db:dbService})]})};lifecycle_machine_stories_MultidocumentEditor.displayName="MultidocumentEditor",lifecycle_machine_stories_MultidocumentEditor.parameters=Object.assign({storySource:{source:"() => {\n    // `database` is a machine that accepts events of the shape \n    //   {type: 'WRITE', key: string, value: string}\n    // We read the machine state directly to query - fine for our demo!\n    let dbService = interpret(database.withContext({ data: { foo: 'hello world' } }));\n\n    let testDocMachine: StateMachine<DocLifecycleContext<string>, any, DocLifecycleEvent> = mkAppLifecycleMachine(\n        async (context) => {\n            return dbService.state.context.data[context.href]\n        },\n        (href, contents) => {\n            return mkWriteDebouncer(contents)\n                .withConfig({\n                    delays: { DEBOUNCE_TIME: 1000 },\n                    services: {\n                        flush: async (context) => {\n                            dbService.send({ type: 'WRITE', key: href, value: context.latestContents })\n                        }\n                    }\n                })\n        })\n    dbService.start()\n\n    let AppToolbar = (props) => {\n        let [state, setState] = React.useState(\"foo\");\n        return <div >\n            <input id=\"openHref\" type=\"text\" value={state} onChange={\n                e => setState(e.target.value)} /> <button onClick={() => props.onOpen(state)}>Open</button>\n        </div>\n    }\n\n    let EditorContainer_ = (props: { service: InterpreterFrom<typeof testDocMachine> }) => {\n        let initialContents = useSelector(props.service, s => s.context.contents)\n        let persister = useSelector(props.service, (s) => s.context.persister)\n        let href = useSelector(props.service, s => s.context.href)\n        return <div>\n            <div><span style={{ fontSize: \"1.2em\" }}>{href}</span>\n                <button style={{ marginLeft: \"2em\" }} onClick={() => props.service.send({ type: 'EXIT' })}>X</button>\n            </div>\n            <DemoEditor initialContents={initialContents}\n                onChange={\n                    (contents) => persister.send({ type: \"WRITE\", value: contents })}\n            />\n        </div>\n    }\n\n    let EditorContainer = React.memo(EditorContainer_)\n\n    type ServiceProp = { service: InterpreterFrom<typeof testDocMachine> }\n\n    let Loading = (props: ServiceProp) => {\n        let [state, _] = useService(props.service)\n        return <div>Loading {state.context.href}</div>\n    }\n\n\n    let WaitRetry = (props: ServiceProp) => {\n        let [state, _] = useService(props.service)\n        return <div>Load failed with {state.context.error}. About to retry...</div>\n    }\n\n    let Running_ = (props: ServiceProp) => {\n        let initialState = useSelector(props.service, state => state.context.contents)\n        let persister = useSelector(props.service, (s) => s.context.persister)\n        return <div>\n            <EditorContainer service={props.service} />\n            <DemoIndicator useDebouncer={useActor as any} debouncer={persister} />\n        </div>\n\n    }\n\n    let Running = React.memo(Running_)\n\n    let Cleanup = (props: ServiceProp) => {\n        let [state, _] = useService(props.service)\n        return <div>\n            <pre>\n                {state.context.persister.getSnapshot().context.latestContents}\n            </pre>\n        </div>\n\n    }\n\n    let LifecycledEditor = (props: { service: InterpreterFrom<typeof testDocMachine> }) => {\n        // Using useSelector causes the Cleanup component to rerender after transitioning from CLEANUP to STOPPED \n        //let stateValue = useSelector(props.service, (s) => s.value)\n        let [state, _] = useService(props.service)\n        let stateValue = state.value\n        switch (stateValue) {\n            case 'PRE_LOAD':\n                return <Loading service={props.service} />\n            case 'LOADING':\n                return <Loading service={props.service} />\n            case 'WAIT_RETRY':\n                return <WaitRetry service={props.service} />\n            case 'RUNNING':\n                return <Running service={props.service} />\n            case 'CLEANUP':\n                return <Cleanup service={props.service} />\n            case 'STOPPED':\n                return <div>done</div>\n        }\n    }\n\n    let EditorGroup = (props) => {\n        let editorMachines = React.useRef({})\n        let editorComponents = props.editors.map(key => {\n            if (!editorMachines.current[key]) {\n                let svc = interpret(testDocMachine.withContext({ href: key }))\n                svc.onDone(() => {\n                    delete editorMachines.current[key]\n                    props.removeEditor(key)\n                })\n                svc.start()\n                editorMachines.current[key] = svc\n                svc.send({ type: \"LOAD\" })\n            }\n            return <LifecycledEditor key={key} service={editorMachines.current[key]} />\n        })\n        return <div>\n            {editorComponents}\n        </div>\n    }\n\n    let Application = () => {\n        let [editors, setEditors] = React.useState([])\n        return <div>\n            <AppToolbar onOpen={(key) => {\n                if (!editors.find((v) => v == key)) {\n                    let newEditors = [...editors, key]\n                    setEditors(newEditors)\n                }\n            }} />\n            <EditorGroup editors={editors} removeEditor={\n                (key) => {\n                    let i = editors.findIndex(v => v == key)\n                    let newEditors = [...editors]\n                    newEditors.splice(i, 1)\n                    setEditors(newEditors)\n                }\n            } />\n        </div>\n    }\n\n\n    return <div id=\"multidocumenteditor\">\n        <Application />\n        <DemoDbInspector db={dbService} />\n    </div>\n}"}},lifecycle_machine_stories_MultidocumentEditor.parameters)},91:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"d",(function(){return database})),__webpack_require__.d(__webpack_exports__,"e",(function(){return stringOutputDebouncer})),__webpack_require__.d(__webpack_exports__,"b",(function(){return DemoEditor})),__webpack_require__.d(__webpack_exports__,"c",(function(){return DemoIndicator})),__webpack_require__.d(__webpack_exports__,"a",(function(){return DemoDbInspector}));__webpack_require__(455),__webpack_require__(36),__webpack_require__(46),__webpack_require__(23),__webpack_require__(115),__webpack_require__(48),__webpack_require__(50),__webpack_require__(53),__webpack_require__(68),__webpack_require__(13),__webpack_require__(119);var xstate__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(174),xstate__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(8),_xstate_react__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(237),immer__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(484),react__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(0),react__WEBPACK_IMPORTED_MODULE_15___default=__webpack_require__.n(react__WEBPACK_IMPORTED_MODULE_15__),_src_debouncer_machine__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(234),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__=__webpack_require__(11);function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=arr&&("undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"]);if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var database=Object(xstate__WEBPACK_IMPORTED_MODULE_11__.b)({id:"database",initial:"running",context:{data:{}},states:{running:{on:{WRITE:{actions:Object(xstate__WEBPACK_IMPORTED_MODULE_12__.b)({data:function(ctx,event){return Object(immer__WEBPACK_IMPORTED_MODULE_14__.a)(ctx.data,(function(draft){draft[event.key]=event.value}))}})}}}}}),stringOutputDebouncer=Object(_src_debouncer_machine__WEBPACK_IMPORTED_MODULE_16__.a)(),DemoEditor=function DemoEditor(props){var _React$useState2=_slicedToArray(react__WEBPACK_IMPORTED_MODULE_15___default.a.useState(props.initialContents),2),contents=_React$useState2[0],onChange=(_React$useState2[1],react__WEBPACK_IMPORTED_MODULE_15___default.a.useCallback((function(event){props.onChange(event.target.value)}),[props.onChange]));return Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("div",{children:Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("textarea",{rows:8,cols:60,onChange:onChange,defaultValue:contents})})};DemoEditor.displayName="DemoEditor";var DemoIndicator=function DemoIndicator(props){var _props$useDebouncer2=_slicedToArray(props.useDebouncer(props.debouncer),2),state=_props$useDebouncer2[0];_props$useDebouncer2[1];return Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("div",{children:Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsxs)("div",{children:[Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("div",{children:Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("h4",{children:"Debounce Status"})}),Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("div",{children:"IDLE"==state.value?"👍 fully saved":"🕜 saving..."}),Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("div",{children:state.context.error?"❌ "+state.context.error:"✅ no errors"})]})})};DemoIndicator.displayName="DemoIndicator";var DemoDbInspector=function DemoDbInspector(props){var _useService2=_slicedToArray(Object(_xstate_react__WEBPACK_IMPORTED_MODULE_13__.b)(props.db),2),state=_useService2[0];_useService2[1];return Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsxs)("div",{children:[Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("div",{children:Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("h4",{children:"DB State"})}),Object(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_17__.jsx)("pre",{children:JSON.stringify(state.context.data,null,2)})]})};DemoDbInspector.displayName="DemoDbInspector";try{DemoEditor.displayName="DemoEditor",DemoEditor.__docgenInfo={description:"",displayName:"DemoEditor",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["packages/core/stories/util.tsx#DemoEditor"]={docgenInfo:DemoEditor.__docgenInfo,name:"DemoEditor",path:"packages/core/stories/util.tsx#DemoEditor"})}catch(__react_docgen_typescript_loader_error){}try{DemoIndicator.displayName="DemoIndicator",DemoIndicator.__docgenInfo={description:"",displayName:"DemoIndicator",props:{debouncer:{defaultValue:null,description:"",name:"debouncer",required:!0,type:{name:"T"}},useDebouncer:{defaultValue:null,description:"",name:"useDebouncer",required:!0,type:{name:"(p: T) => [State<DebounceContext<string>, DebounceEvent<string>, any, Schema<string>>, PayloadSender<any>]"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["packages/core/stories/util.tsx#DemoIndicator"]={docgenInfo:DemoIndicator.__docgenInfo,name:"DemoIndicator",path:"packages/core/stories/util.tsx#DemoIndicator"})}catch(__react_docgen_typescript_loader_error){}try{DemoDbInspector.displayName="DemoDbInspector",DemoDbInspector.__docgenInfo={description:"",displayName:"DemoDbInspector",props:{db:{defaultValue:null,description:"",name:"db",required:!0,type:{name:"Interpreter<{ data: {}; }, any, any, { value: any; context: { data: {}; }; }>"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["packages/core/stories/util.tsx#DemoDbInspector"]={docgenInfo:DemoDbInspector.__docgenInfo,name:"DemoDbInspector",path:"packages/core/stories/util.tsx#DemoDbInspector"})}catch(__react_docgen_typescript_loader_error){}}},[[503,2,3]]]);